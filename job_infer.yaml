$schema: https://azuremlschemas.azureedge.net/latest/commandJob.schema.json
type: command

compute: azureml:lawcoding-dev
code: .

environment:
  image: mcr.microsoft.com/azureml/openmpi4.1.0-ubuntu20.04
  conda_file: ./azureml/environment/conda_test.yaml

# Inputs
inputs:
  # This points to the folder containing 'lora/' and 'classifier.pt'
  model_weights: 
    type: uri_folder
    path: azureml://datastores/workspaceblobstore/paths/outputs/adapters

  data_config:
    type: uri_file
    path: ./azureml/configs/data_infer.json
  model_config:
    type: uri_file
    path: ./azureml/configs/model_infer.json
  inference_config:
    type: uri_file
    path: ./azureml/configs/inference.json

# Command to run
command: >
  python ./azureml/scripts/infer.py
  --model_weights_path ${{inputs.model_weights}}
  --data_config ${{inputs.data_config}}
  --model_config ${{inputs.model_config}}
  --inference_config ${{inputs.inference_config}}
  --output_dir ./outputs/predictions

# Outputs
outputs:
  predictions_dir:
    type: uri_folder
    mode: upload
    path: azureml://datastores/workspaceblobstore/paths/outputs/predictions
